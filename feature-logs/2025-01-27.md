# Feature Log: 2025-01-27

## Summary

1. **Drag & Drop Fix** - Fixed HTML5 drag-and-drop not working due to Tauri intercepting events
2. **Root Drop Zone** - Implemented intuitive drop-to-root by dropping on empty explorer space

---

## 1. Drag & Drop Fix

### Overview

Drag and drop was completely broken - `dragstart` events fired but `dragenter`, `dragover`, and `drop` events never reached React components. The root cause was Tauri's `dragDropEnabled` setting intercepting all drag events at the WebView level for OS file drop handling.

### Root Cause Analysis

The issue was documented in `D&D-PROB.md` during debugging:

1. `dragstart` worked (just a mouse event)
2. All subsequent drag events (which require browser handling) failed
3. Console showed "Drag start: ..." but never "DragEnter on: ..." or "Drop event fired"

### The Fix

**File Modified:** `src-tauri/tauri.conf.json`

```json
{
  "app": {
    "windows": [
      {
        "dragDropEnabled": false,  // ← Added this line
        // ... other config
      }
    ]
  }
}
```

### Why This Works

- `dragDropEnabled: true` (default) enables Tauri to handle file drops from the OS (e.g., dropping files from Windows Explorer into the app)
- This intercepts ALL drag events at the WebView level before they reach the web content
- Setting it to `false` allows HTML5 drag-and-drop to work normally within the app
- Trade-off: Cannot drag files from OS file explorer into the app (not needed for our use case)

---

## 2. Root Drop Zone

### Overview

Implemented the ability to move files from nested folders to the workspace root by dropping them on empty space in the file explorer sidebar.

### Files Modified

| File | Changes |
|------|---------|
| `src/components/layout/Sidebar.tsx` | Added drag handlers to file tree container |
| `src/components/file-tree/FileItem.tsx` | Fixed dragEnd not clearing paths, added dataTransfer fallback |
| `src/stores/fileStore.ts` | Already had `draggedPaths` state from previous implementation |

### Implementation Details

#### Event Flow

```
┌─────────────────────────────────────────────────────────┐
│                    Sidebar Container                     │
│  onDragOver, onDragLeave, onDrop (root drop handlers)   │
│  ┌───────────────────────────────────────────────────┐  │
│  │                    FileTree                        │  │
│  │  ┌─────────────────────────────────────────────┐  │  │
│  │  │  FileItem (folder)                          │  │  │
│  │  │  onDragOver (preventDefault), onDrop        │  │  │
│  │  │  → stopPropagation prevents bubble to root  │  │  │
│  │  └─────────────────────────────────────────────┘  │  │
│  │  ┌─────────────────────────────────────────────┐  │  │
│  │  │  FileItem (file)                            │  │  │
│  │  │  Draggable source only, no drop handling    │  │  │
│  │  └─────────────────────────────────────────────┘  │  │
│  │                                                    │  │
│  │  [Empty space] → Events bubble to Sidebar         │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

#### Key Code - Sidebar.tsx

```typescript
// File tree container acts as root drop zone
<div 
    className={`flex-1 overflow-auto px-2 pb-2 ${isRootDragOver ? "bg-[rgb(99_102_241_/_0.05)]" : ""}`}
    onDragOver={handleRootDragOver}
    onDragLeave={handleRootDragLeave}
    onDrop={handleRootDrop}
>
    <FileTree nodes={filteredTree} depth={0} rootPath={rootPath} />
</div>
```

```typescript
const handleRootDrop = async (e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    setIsRootDragOver(false);

    if (!rootPath) return;

    // Try store first, fallback to dataTransfer
    let sourcePaths = draggedPaths;
    if (sourcePaths.length === 0) {
        const jsonData = e.dataTransfer.getData("application/x-voiddesk-paths");
        if (jsonData) {
            try {
                sourcePaths = JSON.parse(jsonData);
            } catch {
                const plainPath = e.dataTransfer.getData("text/plain");
                if (plainPath) sourcePaths = [plainPath];
            }
        }
    }

    // Build move operations and execute...
};
```

#### Key Code - FileItem.tsx

```typescript
// Folders handle drops with stopPropagation
const handleDrop = async (e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();  // ← Prevents bubble to Sidebar
    // ... move to this folder
    clearDraggedPaths();
};

// dragEnd no longer clears paths (let drop handler do it)
const handleDragEnd = (e: React.DragEvent) => {
    e.stopPropagation();
    target.classList.remove("dragging");
    // clearDraggedPaths() removed - causes race condition
};
```

### Architecture Decisions

1. **Store + dataTransfer fallback** - Use Zustand store for paths, but fallback to reading dataTransfer if store is empty (handles edge cases)

2. **stopPropagation on folder drops** - FileItem's drop handler prevents bubbling so folder drops don't also trigger root drops

3. **dragEnd doesn't clear** - Clearing paths in dragEnd caused race conditions where paths were cleared before drop handler read them

4. **Visual feedback** - Subtle background color change on the container when dragging over empty space

---

## Testing Instructions

### Drag & Drop to Folder

1. Open a project with nested folders
2. Drag a file from one folder
3. Drop it on another folder
4. **Expected**: File moves into the target folder

### Drag & Drop to Root

1. Drag a file from a nested folder (e.g., `src/utils/helper.ts`)
2. Drop it on empty space in the explorer (not on any file/folder)
3. **Expected**: File moves to project root

### Multi-Select Drag

1. Ctrl+Click to select multiple files
2. Drag one of the selected files
3. Drop on a folder or empty space
4. **Expected**: All selected files move together

---

## Summary of All Changes

### Modified Files (3)

- `src-tauri/tauri.conf.json` - Added `dragDropEnabled: false`
- `src/components/layout/Sidebar.tsx` - Root drop zone on container
- `src/components/file-tree/FileItem.tsx` - Fixed dragEnd race condition, added dataTransfer fallback

### Documentation Updated

- `D&D-PROB.md` - Created analysis document, marked as resolved

### Key Insight

When using Tauri 2.0, always check if platform-level features are intercepting web events. The `dragDropEnabled` setting is meant for accepting files from the OS, but it blocks internal drag operations entirely.
