# Feature Log: 2025-01-23

## Summary

This session implemented two major features for VoiDesk:
1. **File Watching** - Automatic file tree refresh when files change externally
2. **Find & Replace** - Full CodeMirror search integration with keyboard shortcuts

---

## 1. File Watching Feature

### Overview
Added automatic file system monitoring using the Rust `notify` crate. When files are modified, created, or deleted outside the IDE (e.g., via terminal, another editor, or git operations), the file tree automatically refreshes to reflect those changes.

### Files Created

| File | Purpose |
|------|---------|
| `src-tauri/src/commands/file_watcher.rs` | Rust module for file system watching with debouncing |
| `src/hooks/useFileWatcher.ts` | React hook to manage watcher lifecycle and event handling |

### Files Modified

| File | Changes |
|------|---------|
| `src-tauri/Cargo.toml` | Added `notify = { version = "6", features = ["macos_fsevent"] }` |
| `src-tauri/src/commands/mod.rs` | Added `pub mod file_watcher;` |
| `src-tauri/src/lib.rs` | Registered `start_file_watcher`, `stop_file_watcher`, `is_watching` commands |
| `src/App.tsx` | Added `useFileWatcher()` hook integration |

### Dependencies Added

**Cargo (Rust):**
```toml
notify = { version = "6", features = ["macos_fsevent"] }
```

### Implementation Details

#### Backend Architecture (Rust)

The file watcher uses a global state pattern with `OnceLock` and `Mutex` to persist the watcher across Tauri command invocations:

```rust
static WATCHER: std::sync::OnceLock<Mutex<Option<WatcherState>>> = std::sync::OnceLock::new();

struct WatcherState {
    _watcher: RecommendedWatcher,
    watched_path: String,
}
```

#### Debouncing Strategy

Events are debounced using a tokio channel and `tokio::select!`:

```rust
let (tx, mut rx) = mpsc::channel::<Event>(100);

tokio::spawn(async move {
    let mut pending_events: Vec<Event> = Vec::new();
    let debounce_duration = Duration::from_millis(500);
    
    loop {
        tokio::select! {
            Some(event) = rx.recv() => {
                pending_events.push(event);
            }
            _ = tokio::time::sleep(debounce_duration), if !pending_events.is_empty() => {
                // Process and emit accumulated events
                // ...
                app.emit("file-change", FileChangeEvent { event_type, paths });
            }
        }
    }
});
```

#### Event Flow

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│  File System    │────►│  notify crate    │────►│  tokio channel  │
│  (external)     │     │  (watcher)       │     │  (debounce)     │
└─────────────────┘     └──────────────────┘     └────────┬────────┘
                                                          │
                                                          ▼ (500ms)
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│  File Tree      │◄────│  useFileWatcher  │◄────│  Tauri emit()   │
│  (refreshed)    │     │  (React hook)    │     │  "file-change"  │
└─────────────────┘     └──────────────────┘     └─────────────────┘
```

#### Frontend Hook

```typescript
export function useFileWatcher() {
    const { rootPath, setFileTree } = useFileStore();
    
    useEffect(() => {
        if (rootPath) {
            // Listen for file-change events
            const unlisten = listen<FileChangeEvent>("file-change", (event) => {
                refreshFileTree(rootPath);
            });
            
            // Start the watcher
            invoke("start_file_watcher", { path: rootPath });
        }
        
        return () => {
            invoke("stop_file_watcher");
        };
    }, [rootPath]);
}
```

### Architecture Decisions

1. **500ms Debounce**: Chosen to balance responsiveness with avoiding excessive refreshes during rapid file operations (e.g., `npm install` creating many files)

2. **Global Watcher State**: Using `OnceLock<Mutex<Option<WatcherState>>>` ensures only one watcher exists at a time and persists across async command calls

3. **Recursive Watching**: `RecursiveMode::Recursive` watches all subdirectories, essential for project-wide monitoring

4. **Event Batching**: Multiple events within the debounce window are batched and deduplicated before emitting

---

## 2. Find & Replace Feature

### Overview
Integrated CodeMirror 6's `@codemirror/search` package to provide full find and replace functionality with keyboard shortcuts.

### Files Modified

| File | Changes |
|------|---------|
| `package.json` | Added `@codemirror/search` dependency |
| `src/components/editor/CodeEditor.tsx` | Added search extensions and keymap |
| `src/index.css` | Added custom styling for search panel |

### Dependencies Added

**npm:**
```bash
npm install @codemirror/search
```

### Implementation Details

#### CodeMirror Extensions

Added to `CodeEditor.tsx`:

```tsx
import {
    search,
    searchKeymap,
    highlightSelectionMatches,
} from "@codemirror/search";

// In EditorState.create() extensions array:
search({ top: true }),  // Show panel at top of editor
highlightSelectionMatches(),

// In keymap:
keymap.of([
    ...closeBracketsKeymap,
    ...defaultKeymap,
    ...historyKeymap,
    ...searchKeymap,  // Added
    indentWithTab,
]),
```

#### Custom CSS Styling

Added VoiDesk-themed styles for the search panel in `src/index.css`:

```css
.cm-search {
    background: var(--color-void-800) !important;
    border-bottom: 1px solid var(--color-border-subtle) !important;
    padding: 8px 12px !important;
    font-family: var(--font-mono) !important;
}

.cm-search input:focus {
    border-color: var(--color-accent-primary) !important;
}

.cm-searchMatch {
    background: rgba(99, 102, 241, 0.3) !important;
}

.cm-searchMatch-selected {
    background: rgba(99, 102, 241, 0.6) !important;
}

.cm-selectionMatch {
    background: rgba(255, 255, 255, 0.1) !important;
}
```

### Keyboard Shortcuts

| Shortcut | Action |
|----------|--------|
| `Ctrl+F` | Open find panel |
| `Ctrl+H` | Open find & replace panel |
| `F3` | Go to next match |
| `Shift+F3` | Go to previous match |
| `Enter` | Next match (when in find field) |
| `Escape` | Close search panel |
| `Alt+Enter` | Select all matches |

### Features Included

- **Case Sensitivity Toggle**: Click "Aa" button to toggle
- **Regex Toggle**: Click ".*" button to enable regex patterns
- **Match Count**: Shows "X of Y" matches
- **Replace / Replace All**: Available in replace mode (Ctrl+H)
- **Selection Highlighting**: Other occurrences of selected text are highlighted
- **Auto-fill**: Selected text is automatically filled into search field

---

## Testing Instructions

### File Watching

1. Start the app: `npm run tauri dev`
2. Open a project folder
3. In a separate terminal or file explorer:
   - Create a new file in the project
   - Modify an existing file
   - Delete a file
4. **Expected**: File tree updates automatically within ~500ms

### Find & Replace

1. Open any file in the editor
2. Press `Ctrl+F` to open find panel
3. Type a search term
4. **Expected**: Matches are highlighted, count is shown
5. Press `F3` to navigate between matches
6. Press `Ctrl+H` to open replace mode
7. Enter replacement text and click "Replace" or "Replace All"
8. Test regex by clicking ".*" and entering a pattern like `\d+`
9. Press `Escape` to close the panel

---

## Summary of All Changes

### New Files (2)
- `src-tauri/src/commands/file_watcher.rs`
- `src/hooks/useFileWatcher.ts`

### Modified Files (6)
- `src-tauri/Cargo.toml`
- `src-tauri/src/commands/mod.rs`
- `src-tauri/src/lib.rs`
- `src/App.tsx`
- `src/components/editor/CodeEditor.tsx`
- `src/index.css`

### Dependencies Added
- **Rust**: `notify = "6"` (with `macos_fsevent` feature)
- **npm**: `@codemirror/search`

### Tauri Commands Added
- `start_file_watcher(path: String)` - Start watching a directory
- `stop_file_watcher()` - Stop the current watcher
- `is_watching()` - Check if watcher is active

### Events Added
- `file-change` - Emitted when files change (payload: `{ event_type, paths }`)
