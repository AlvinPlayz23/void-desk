# Inline AI Completions (Ghost Text) Feature

**Implemented:** 2026-01-24
**Updated:** 2026-01-24 (Bug fixes for keybindings)

## Overview

This feature adds GitHub Copilot-style inline AI completions to the CodeMirror editor. Suggestions appear as grayed-out "ghost text" after the cursor position.

## How It Works

1. **Trigger**: After typing and a 500ms pause (debounced), the system sends the current file content and cursor position to the AI
2. **Display**: Suggestions appear as semi-transparent italic text at the cursor position with a hint tooltip showing keyboard shortcuts
3. **Loading Indicator**: "AI thinking..." appears in bottom-right corner while fetching completions
4. **Acceptance**: 
   - **Tab**: Accept the entire suggestion
   - **Ctrl+Right** (Win/Linux) / **Cmd+Right** (macOS): Accept word-by-word
   - **Escape**: Dismiss the suggestion
   - **Typing**: Auto-dismisses and continues with normal input

## Files Changed

### Frontend (React/TypeScript)

- **`src/hooks/useInlineCompletion.ts`** (NEW)
  - Manages AI completion requests with debouncing
  - Handles cancellation of in-flight requests
  - Uses refs (`completionRef`) for synchronous access in keymaps
  - Provides `completion`, `isLoading`, `requestCompletion`, `clearCompletion`, `acceptAll`, `acceptWord`, `hasCompletion`

- **`src/components/editor/ghostText.ts`** (NEW)
  - CodeMirror extension for rendering ghost text decorations
  - Uses `StateField` with `Decoration.widget`
  - Custom keymap with `Prec.highest` priority for Tab/Ctrl+Right/Escape handling
  - Uses ref-based callbacks to avoid stale closure issues
  - Displays hint tooltip with keyboard shortcuts below ghost text

- **`src/components/editor/CodeEditor.tsx`** (MODIFIED)
  - Integrates `useInlineCompletion` hook with ref-based callbacks
  - Adds `ghostTextExtension()` and keymap to editor state
  - Triggers completion requests on document changes
  - Updates ghost text decorations when completion changes
  - Shows loading indicator in bottom-right corner

- **`src/stores/settingsStore.ts`** (MODIFIED)
  - Added `inlineCompletionsEnabled: boolean` (default: true)
  - Added `setInlineCompletionsEnabled` action

- **`src/components/ui/SettingsModal.tsx`** (MODIFIED)
  - Added toggle switch for enabling/disabling inline completions

### Backend (Rust/Tauri)

- **`src-tauri/src/commands/ai_commands.rs`** (MODIFIED)
  - Added `InlineCompletionChunk` struct
  - Added `get_inline_completion` command
  - Uses lightweight agent without tools for faster responses
  - Specialized prompt for code completion (no markdown, no explanations)

- **`src-tauri/src/lib.rs`** (MODIFIED)
  - Registered `get_inline_completion` command

## Technical Details

### Ghost Text Styling
```css
opacity: 0.4;
font-style: italic;
color: var(--color-text-secondary, #888);
pointer-events: none;
white-space: pre;
```

### AI Prompt Template
The AI receives:
- Language and file path
- Code before cursor position
- Code after cursor position
- Instruction to output only raw code (1-3 lines max)

### Performance Optimizations
- 500ms debounce to avoid excessive API calls
- Request cancellation when user continues typing
- Request ID tracking to ignore stale responses
- Ephemeral sessions for each completion (no memory overhead)

## Settings

Toggle in **Settings > AI Settings > Inline AI Completions**

## Keyboard Shortcuts

| Action | Windows/Linux | macOS |
|--------|---------------|-------|
| Accept all | Tab | Tab |
| Accept word | Ctrl+Right | Cmd+Right |
| Dismiss | Escape | Escape |
