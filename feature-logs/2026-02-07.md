# Feature Log: 2026-02-07

## Summary

Brief list of all major features/changes implemented in this session:
1. **SDK Rewrite + Streaming Parsing** - Reworked the custom AI SDK structure, added typed stream parsing, and improved SSE handling.
2. **Zed-Style Edit Tools** - Implemented `edit_file` and `streaming_edit_file` with old_text/new_text edits, fuzzy matching, diff output, and conflict detection.
3. **Tool Safety + Read Enhancements** - Added sensitive-path gating and line-range reads.
4. **Model Capabilities + Error Typing** - Added model capability inference and structured error types to improve client behavior.
5. **UI Tool Diff Display** - Tool operations now surface diff details in the AI chat panel.

---

## 1. SDK Rewrite + Streaming Parsing

### Overview
Restructured the AI SDK into a modular layout and introduced typed stream parsing to handle OpenAI-compatible SSE responses more robustly. This improves provider compatibility, tool-call handling, and reasoning stream extraction.

### Files Created

| File | Purpose |
|------|---------|
| `src-tauri/src/sdk/provider/registry.rs` | Provider registry to track available providers and their models |

### Files Modified

| File | Changes |
|------|---------|
| `src-tauri/src/sdk/core/types.rs` | Added streaming response structures and tool schema format |
| `src-tauri/src/sdk/stream/parse.rs` | Switched to typed SSE parsing, tool-call accumulation, reasoning support |
| `src-tauri/src/sdk/provider/mod.rs` | Model capability inference and metadata |
| `src-tauri/src/sdk/provider/openai_compatible.rs` | Uses inferred model capabilities |
| `src-tauri/src/sdk/agent.rs` | Agent orchestration updates (no tool blocking) |
| `src-tauri/src/sdk/mod.rs` | Updated public exports |
| `src-tauri/src/sdk/client.rs` | Added model_info access |

### Dependencies Added

**Cargo (Rust):**
None

**npm (JavaScript/TypeScript):**
None

### Implementation Details

#### Typed Stream Parsing
Added typed response structures and used them in SSE parsing:

```rust
#[derive(Debug, Clone, Deserialize)]
pub struct ResponseStreamResult {
    pub choices: Vec<ResponseStreamChoice>,
    pub usage: Option<Usage>,
    pub error: Option<ResponseStreamError>,
}
```

Parsing now extracts:
- `delta.content`
- `delta.text`
- `delta.reasoning` / `delta.reasoning_content`
- `delta.tool_calls`

### Architecture Decisions

1. **Typed SSE parsing** - Reduced brittle JSON lookups and made tool-call handling safer.
2. **Model capability inference** - Added metadata for model features (not used to disable tools).

---

## 2. Zed-Style Edit Tools

### Overview
Introduced Zed-style edit tools that operate on `old_text`/`new_text` pairs. These edits support fuzzy matching (whitespace-tolerant), conflict detection, and diff previews, and are shared between `edit_file` and `streaming_edit_file`.

### Files Modified

| File | Changes |
|------|---------|
| `src-tauri/src/commands/ai_tools.rs` | Implemented edit tool logic, fuzzy matching, diff creation |
| `src-tauri/src/commands/ai_service.rs` | Updated system prompt with new tool usage |
| `src-tauri/src/commands/ai_commands.rs` | Tool operation mapping includes edit tools |

### Implementation Details

#### Shared Edit Logic
Both tools use a shared executor to avoid divergence:

```rust
fn execute_edit_file(args: EditFileArgs, root: &str) -> Result<AgentToolOutput> { ... }
```

#### Fuzzy Matching
If exact matches fail, a whitespace-normalized search is used:

```rust
fn normalize_text(text: &str) -> String {
    // collapses whitespace to single spaces
}
```

#### Conflict Detection
Edits are sorted and overlapping ranges are rejected:

```rust
if prev.range.end > curr.range.start {
    return Err(anyhow!("Conflicting edit ranges detected..."));
}
```

### Architecture Decisions

1. **Single-file edits only** - Mirrors Zed behavior; multi-file edits can be layered later.
2. **Exact match first, then fuzzy** - Preserves deterministic behavior while reducing failure rates.

---

## 3. Tool Safety + Read Enhancements

### Overview
Added sensitive-path gating to prevent accidental writes or edits, and enhanced `read_file` to support line ranges.

### Files Modified

| File | Changes |
|------|---------|
| `src-tauri/src/commands/ai_tools.rs` | Added `allow_sensitive`, sensitive path checks, line-range reads |

### Implementation Details

#### Sensitive Path Gating
Writes and edits are blocked unless explicitly overridden:

```rust
if is_sensitive_path(path) {
    return Err(anyhow!("Permission denied... allow_sensitive=true"));
}
```

#### Line-Range Reads
`read_file` supports optional `start_line` and `end_line`.

---

## 4. Model Capabilities + Error Typing

### Overview
Added model capability inference and structured error types to better control tools and surface diagnostics to the UI.

### Files Modified

| File | Changes |
|------|---------|
| `src-tauri/src/sdk/provider/mod.rs` | Added `infer_model_capabilities` |
| `src-tauri/src/sdk/agent.rs` | Agent orchestration updates (no tool blocking) |
| `src-tauri/src/commands/ai_commands.rs` | Added `error_type` classification |
| `src/hooks/useAI.ts` | Display error type in logs/UI |

### Implementation Details

#### Error Types
Errors are classified into categories:
- `permission`
- `provider`
- `tool`
- `validation`
- `model`
- `internal`

---

## 5. UI Tool Diff Display

### Overview
Tool operation UI now surfaces diff output from edit tools to provide immediate feedback on what changed.

### Files Modified

| File | Changes |
|------|---------|
| `src/stores/chatStore.ts` | Added `details` to `ToolOperation` |
| `src/components/ai/AIChat.tsx` | Render diff details in tool operation display |

---

## Testing Instructions

### SDK + Tooling
1. Run `npm run tauri dev`
2. Use AI panel to call:
   - `read_file` with `start_line` / `end_line`
   - `edit_file` with `old_text`/`new_text`
   - `streaming_edit_file` with multiple edits
3. **Expected**: Tool operations show status and diff output; file tree refreshes after edits.

---

## Summary of All Changes

### New Files (1)
- `src-tauri/src/sdk/provider/registry.rs`

### Modified Files (12)
- `src-tauri/src/sdk/core/types.rs`
- `src-tauri/src/sdk/stream/parse.rs`
- `src-tauri/src/sdk/provider/mod.rs`
- `src-tauri/src/sdk/provider/openai_compatible.rs`
- `src-tauri/src/sdk/agent.rs`
- `src-tauri/src/sdk/mod.rs`
- `src-tauri/src/sdk/client.rs`
- `src-tauri/src/commands/ai_tools.rs`
- `src-tauri/src/commands/ai_commands.rs`
- `src-tauri/src/commands/ai_service.rs`
- `src/hooks/useAI.ts`
- `src/components/ai/AIChat.tsx`
- `src/stores/chatStore.ts`

### Documentation Updated
- `feature-logs/2026-02-07.md` - Added session log

### Dependencies Added
- **Rust**: None
- **npm**: None

### Tauri Commands Added (if any)
- None

### Events Added (if any)
- `error_type` in AI response chunks
