# Feature Log: 2026-02-08

## Summary

1. **Terminal Multi-Tabs & Split Panes** - VSCode-style multiple terminal tabs with horizontal/vertical split pane support
2. **Recent Projects List** - Persisted list of recently opened project folders shown in the sidebar empty state
3. **Session Restore** - Automatically restores open file tabs, active file, terminal layout, and panel visibility on app relaunch

---

## 1. Terminal Multi-Tabs & Split Panes

### Overview

Replaced the single-terminal implementation with a full multi-tab, split-pane terminal system similar to VSCode. Each tab can contain multiple terminal panes arranged via horizontal/vertical splits. Each pane runs its own independent PTY process. The layout is persisted and restored across sessions.

### Files Created

| File | Purpose |
|------|---------|
| `src/stores/terminalStore.ts` | Zustand store managing terminal tabs, panes, and recursive split-tree layout with persist |
| `src/components/terminal/TerminalPane.tsx` | Individual xterm.js + PTY instance with ResizeObserver for split-aware fitting |
| `src/components/terminal/TerminalTabBar.tsx` | Tab bar UI with new tab (+), close tab (x), split-right, and split-down buttons |
| `src/components/terminal/TerminalSplitView.tsx` | Recursive renderer for the split-tree layout (leaf → pane, split → flex container) |
| `src/components/terminal/TerminalPanel.tsx` | Top-level component composing tab bar + split view, replaces old TerminalComponent |

### Files Modified

| File | Changes |
|------|---------|
| `src/components/layout/MainLayout.tsx` | Replaced `TerminalComponent` import/usage with `TerminalPanel` |

### Implementation Details

#### Split-Tree Data Model

The terminal layout uses a recursive tree structure where each node is either a leaf (single pane) or a split (two children):

```typescript
type TerminalLayoutNode =
    | { type: "leaf"; paneId: string }
    | { type: "split"; direction: SplitDirection; a: TerminalLayoutNode; b: TerminalLayoutNode; ratio: number };
```

Each tab holds one root `TerminalLayoutNode` plus a `panesById` record mapping pane IDs to pane metadata.

#### Split Operations

Splitting replaces the target leaf node with a split node containing the original pane and a new pane:

```typescript
splitPane: (tabId, paneId, direction) => {
    // Find leaf with paneId in tree, replace with:
    // { type: "split", direction, a: originalLeaf, b: newLeaf, ratio: 0.5 }
}
```

Closing a pane promotes the sibling node to replace the parent split node.

#### ResizeObserver per Pane

Each `TerminalPane` uses a `ResizeObserver` (instead of `window.resize`) to fit its xterm instance correctly when panes resize due to splits:

```typescript
const resizeObserver = new ResizeObserver(() => {
    // Debounced: fitAddon.fit() + invoke resize_pty
});
resizeObserver.observe(containerRef.current);
```

#### Persist Strategy

Terminal layout (tabs, split tree, active tab/pane) is persisted, but PTY pids are stripped to `null` during serialization. On restore, panes remount and create fresh PTY processes.

### Architecture Diagram

```
┌──────────────────────────────────────┐
│           TerminalPanel              │
│  ┌────────────────────────────────┐  │
│  │        TerminalTabBar          │  │
│  │  [Tab 1] [Tab 2] [+] [⫼] [≡] │  │
│  └────────────────────────────────┘  │
│  ┌────────────────────────────────┐  │
│  │      TerminalSplitView         │  │
│  │  ┌──────────┬──────────┐       │  │
│  │  │ Terminal │ Terminal │       │  │
│  │  │ Pane A   │ Pane B   │       │  │
│  │  │ (PTY 0)  │ (PTY 1)  │       │  │
│  │  └──────────┴──────────┘       │  │
│  └────────────────────────────────┘  │
└──────────────────────────────────────┘
```

### Architecture Decisions

1. **Recursive split tree** - Chose a `leaf | split` ADT over a flat list because it naturally supports arbitrary nesting and clean pane removal (promote sibling)
2. **ResizeObserver over window.resize** - Critical for split panes; each pane must independently refit when its container changes size, not just when the window resizes
3. **Per-pane PTY listeners** - Each pane filters `pty-output` events by its own pid. Acceptable for small pane counts; could centralize later if needed
4. **No backend changes** - `terminal.rs` already supports multiple PTYs keyed by pid, so all changes are frontend-only

---

## 2. Recent Projects List

### Overview

Added a persisted list of recently opened project folders. When no project is open, the sidebar shows the list of recent projects with one-click reopening, individual removal, and a clear-all button.

### Files Modified

| File | Changes |
|------|---------|
| `src/stores/fileStore.ts` | Added `recentProjects` array with `addRecentProject`, `removeRecentProject`, `clearRecentProjects` actions; wrapped store with `persist` middleware |
| `src/hooks/useFileSystem.ts` | Added `openFolderAt(path)` for reopening a project without the folder picker dialog; existing `openFolder()` now also calls `addRecentProject` |
| `src/components/layout/Sidebar.tsx` | Replaced empty state with recent projects list UI; added `Clock` and `Trash2` icons |

### Implementation Details

#### Recent Projects Storage

```typescript
recentProjects: { path: string; name: string; lastOpenedAt: number }[];

addRecentProject: (path) => {
    // Extract folder name from path
    // Deduplicate by path, prepend newest, cap at 10
};
```

#### Direct Folder Opening

```typescript
const openFolderAt = async (path: string): Promise<boolean> => {
    setRootPath(path);
    await refreshFileTree(path);
    useFileStore.getState().addRecentProject(path);
    return true;
};
```

#### Sidebar UI

When no project is open, the sidebar displays:
- "No folder open" message with Open Folder button
- **Recent** section with folder icon, project name, full path, and per-item remove button
- Clear all button in the section header

### Architecture Decisions

1. **Stored in fileStore with persist** - Natural home alongside `rootPath`; persisted via Zustand's `partialize` to localStorage
2. **Cap at 10 projects** - Keeps the list manageable and localStorage usage low
3. **openFolderAt vs openFolder** - Separate function that skips the dialog picker, enabling one-click reopen from the recent list

---

## 3. Session Restore

### Overview

On app relaunch, VoiDesk now restores the last session's state: open file tabs, active file, file tree, terminal layout, and panel visibility. File content is re-read from disk (not cached) to ensure freshness.

### Files Created

| File | Purpose |
|------|---------|
| `src/hooks/useSessionRestore.ts` | One-time effect that restores file tree + open tabs from persisted session metadata |

### Files Modified

| File | Changes |
|------|---------|
| `src/stores/fileStore.ts` | Added `sessionOpenFiles` and `sessionCurrentFilePath` for persisting tab metadata; `openFile`/`closeFile`/`setCurrentFile` now auto-save session |
| `src/stores/uiStore.ts` | Added `isTerminalVisible` and `isAIPanelVisible` to the `partialize` config |
| `src/App.tsx` | Added `useSessionRestore()` hook call |

### Implementation Details

#### Session Metadata (Not Full Content)

Only file metadata is persisted — never full file content:

```typescript
sessionOpenFiles: { path: string; name: string; language: string }[];
sessionCurrentFilePath: string | null;

saveSession: () => {
    // Snapshot openFiles as metadata-only, save currentFilePath
};
```

`saveSession()` is called automatically inside `openFile`, `closeFile`, and `setCurrentFile`.

#### Restore Flow

```typescript
useSessionRestore() {
    // 1. Wait for Zustand rehydration (100ms delay)
    // 2. If rootPath exists, refresh file tree from disk
    // 3. For each sessionOpenFile, read content via invoke("read_file")
    // 4. Open each file in the editor (skips files that no longer exist)
    // 5. Restore currentFilePath
    // 6. Add rootPath to recent projects
}
```

#### What Gets Restored

| State | Persisted In | Restored How |
|-------|-------------|--------------|
| Open file tabs | `fileStore.sessionOpenFiles` | Re-read from disk, opened in editor |
| Active file | `fileStore.sessionCurrentFilePath` | Set after all tabs restored |
| File tree | `fileStore.rootPath` | Refreshed from disk via `get_project_tree` |
| Terminal tabs/splits | `terminalStore.tabs` | Layout restored, fresh PTY processes created |
| Panel visibility | `uiStore.isTerminalVisible/isAIPanelVisible` | Directly restored by Zustand persist |
| Panel sizes | `uiStore.sidebarWidth/aiPanelWidth/terminalHeight` | Directly restored by Zustand persist |

### Architecture Decisions

1. **Metadata-only persistence** - Persisting full file content would bloat localStorage and risk stale data; re-reading from disk is safer and simpler
2. **Delayed restore** - 100ms setTimeout ensures Zustand stores have rehydrated from localStorage before restore logic runs
3. **Silent failure** - Files that no longer exist on disk are silently skipped rather than showing errors
4. **Auto-save session** - Every `openFile`/`closeFile`/`setCurrentFile` triggers `saveSession()` so the persisted state is always current

---

## Testing Instructions

### Terminal Multi-Tabs

1. Open terminal with Ctrl+`
2. Click `+` button in terminal tab bar → **Expected**: New tab appears, switches to it
3. Click the split-right button (⫼ icon) → **Expected**: Active pane splits vertically, new terminal appears on the right
4. Click the split-down button (≡ icon) → **Expected**: Active pane splits horizontally, new terminal appears below
5. Type in different panes → **Expected**: Each pane has its own independent shell session
6. Click the X on a tab → **Expected**: Tab closes, switches to adjacent tab
7. Click between panes → **Expected**: Active pane gets subtle indigo border highlight

### Recent Projects

1. Open a folder via Ctrl+O
2. Close and reopen VoiDesk (or open a different folder)
3. When no project is open → **Expected**: Sidebar shows "Recent" section with previously opened folder
4. Click a recent project → **Expected**: Project opens immediately without folder picker dialog
5. Click trash icon on a recent entry → **Expected**: Entry is removed from the list
6. Click "Clear" button → **Expected**: All recent projects are cleared

### Session Restore

1. Open a project folder
2. Open 3-4 files in editor tabs
3. Open the terminal, create a split
4. Open the AI panel
5. Close and reopen VoiDesk
6. **Expected**: Same project folder loads, same file tabs are open, same file is active, terminal panel is visible with same tab/split layout (fresh shells), AI panel is visible

---

## Summary of All Changes

### New Files (6)
- `src/stores/terminalStore.ts`
- `src/components/terminal/TerminalPane.tsx`
- `src/components/terminal/TerminalTabBar.tsx`
- `src/components/terminal/TerminalSplitView.tsx`
- `src/components/terminal/TerminalPanel.tsx`
- `src/hooks/useSessionRestore.ts`

### Modified Files (5)
- `src/components/layout/MainLayout.tsx`
- `src/stores/fileStore.ts`
- `src/stores/uiStore.ts`
- `src/hooks/useFileSystem.ts`
- `src/components/layout/Sidebar.tsx`
- `src/App.tsx`

### No Backend Changes
- `terminal.rs` already supported multiple PTYs — all changes are frontend-only

### No Dependencies Added
- All features built with existing libraries (Zustand, xterm.js, lucide-react, Tauri API)
