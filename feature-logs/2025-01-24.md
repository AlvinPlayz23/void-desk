# Feature Log: 2025-01-24

## Summary

This session focused on **fixing the LSP integration** to make autocomplete and hover tooltips fully functional:

1. **LSP Autocomplete & Hover Fix** - Resolved multiple issues preventing language server responses from reaching the frontend
2. **Proper Windows URI Formatting** - Fixed `file:///` URI construction for Windows paths
3. **Request/Response Routing** - Implemented oneshot channel-based routing to prevent response stealing
4. **Server Request Handling** - Added responses to `workspace/configuration` and other server-initiated requests

---

## 1. LSP Autocomplete & Hover Fix

### Overview

The LSP infrastructure was communicating with the language server, but completions and hover requests were either returning empty results or timing out. This session diagnosed and fixed multiple root causes.

### Root Causes Identified

1. **Malformed Windows URI** - `rootUri` was formatted as `file://C:/...` instead of `file:///C:/...`
2. **Response Stealing** - Multiple concurrent requests (hover + completion) competed for the same response channel
3. **Unhandled Server Requests** - `typescript-language-server` sends `workspace/configuration` requests and blocks until responded

### Files Modified

| File | Changes |
|------|---------|
| `src-tauri/src/lsp/transport.rs` | Complete rewrite with background reader, oneshot channels, server request handling |
| `src-tauri/src/lsp/manager.rs` | Refactored to use new transport API, fixed `rootUri` construction |
| `src-tauri/src/lsp/protocol.rs` | Added path canonicalization for consistent URIs |
| `src/hooks/useLsp.ts` | Removed unused imports |
| `src/components/editor/CodeEditor.tsx` | Minor fix to `didOpen` effect |
| `src/components/ai/AIChat.tsx` | Removed unused destructured variable |
| `src/components/file-tree/FileTree.tsx` | Fixed unused parameter warning |
| `src/stores/fileStore.ts` | Removed unused destructured variable |
| `AGENTS.md` | Updated implementation status and next steps |
| `LSP.md` | Complete rewrite with current architecture |

### Implementation Details

#### 1. Fixed Windows URI Formatting

**Before (Broken):**
```rust
"rootUri": format!("file://{}", root_uri.replace("\\", "/"))
// Produces: file://C:/Users/... (invalid - C: parsed as hostname)
```

**After (Fixed):**
```rust
use lsp_types::Url;

let root_url = Url::from_directory_path(Path::new(root_path_str))
    .map_err(|_| format!("Invalid root path: {}", root_path_str))?;

"rootUri": root_url.to_string()
// Produces: file:///C:/Users/... (correct)
```

#### 2. Background Reader with Oneshot Channels

The new transport architecture prevents response stealing by routing each response to its specific waiting request:

```rust
pub struct LspTransport {
    writer: Arc<StdinWriter>,
    pending_requests: Arc<Mutex<HashMap<u64, oneshot::Sender<Value>>>>,
    next_id: Mutex<u64>,
}

pub async fn send_request(&self, method: &str, params: Value) -> Result<Value, String> {
    let id = { /* get next id */ };
    
    // Create oneshot channel for this specific request
    let (tx, rx) = oneshot::channel();
    
    // Register pending request
    self.pending_requests.lock().await.insert(id, tx);
    
    // Send request
    self.writer.write_message(&request)?;
    
    // Wait for response with timeout
    match tokio::time::timeout(Duration::from_secs(10), rx).await {
        Ok(Ok(response)) => Ok(response.get("result").cloned().unwrap_or(Value::Null)),
        Ok(Err(_)) => Err("Response channel closed".to_string()),
        Err(_) => Err("Request timed out".to_string()),
    }
}
```

#### 3. Server Request Handling

The background reader now responds to server-initiated requests:

```rust
} else if has_id && has_method {
    // Request from server - we need to respond!
    let method = json.get("method").and_then(|v| v.as_str()).unwrap_or("");
    let id = json.get("id").cloned().unwrap_or(Value::Null);
    
    let response_result = match method {
        "workspace/configuration" => {
            // Return empty config for each requested item
            if let Some(items) = json.get("params")
                .and_then(|p| p.get("items"))
                .and_then(|i| i.as_array()) 
            {
                let configs: Vec<Value> = items.iter()
                    .map(|_| serde_json::json!({}))
                    .collect();
                serde_json::json!(configs)
            } else {
                serde_json::json!([{}])
            }
        }
        "client/registerCapability" => serde_json::json!(null),
        "window/workDoneProgress/create" => serde_json::json!(null),
        _ => serde_json::json!(null),
    };
    
    writer.send_response(id, response_result)?;
}
```

#### 4. Enhanced Initialize Capabilities

Added proper workspace and text document capabilities:

```rust
let init_params = serde_json::json!({
    "processId": std::process::id(),
    "rootUri": root_url.to_string(),
    "rootPath": root_path_str,
    "workspaceFolders": [{
        "uri": root_url.to_string(),
        "name": workspace_name
    }],
    "capabilities": {
        "workspace": {
            "workspaceFolders": true,
            "configuration": true
        },
        "textDocument": {
            "synchronization": {
                "didSave": true,
                "willSave": false,
                "willSaveWaitUntil": false,
                "dynamicRegistration": false
            },
            "completion": {
                "completionItem": {
                    "snippetSupport": true,
                    "documentationFormat": ["markdown", "plaintext"],
                    "deprecatedSupport": true,
                    "labelDetailsSupport": true
                },
                "contextSupport": true
            },
            "hover": {
                "contentFormat": ["markdown", "plaintext"]
            }
        }
    }
});
```

### Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                         LspTransport                                │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                    Background Reader Task                     │  │
│  │  ┌─────────────┐    ┌─────────────────┐    ┌──────────────┐ │  │
│  │  │ Read JSON   │───►│ Route by Type   │───►│ Response?    │ │  │
│  │  │ from stdout │    │ (id? method?)   │    │ → oneshot tx │ │  │
│  │  └─────────────┘    └─────────────────┘    └──────────────┘ │  │
│  │                            │                                  │  │
│  │                            ▼                                  │  │
│  │                     ┌──────────────┐                         │  │
│  │                     │ Server Req?  │                         │  │
│  │                     │ → respond    │                         │  │
│  │                     └──────────────┘                         │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                    Request Handling                           │  │
│  │  ┌─────────────┐    ┌─────────────────┐    ┌──────────────┐ │  │
│  │  │ send_request│───►│ Create oneshot  │───►│ Register in  │ │  │
│  │  │ (method,    │    │ channel (tx,rx) │    │ pending_reqs │ │  │
│  │  │  params)    │    └─────────────────┘    └──────────────┘ │  │
│  │  └─────────────┘                                  │          │  │
│  │         │                                         │          │  │
│  │         ▼                                         ▼          │  │
│  │  ┌─────────────┐                          ┌──────────────┐  │  │
│  │  │ Write to    │                          │ await rx     │  │  │
│  │  │ stdin       │                          │ (10s timeout)│  │  │
│  │  └─────────────┘                          └──────────────┘  │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

### Message Flow

```
┌──────────────┐     ┌──────────────┐     ┌──────────────────────┐
│   Frontend   │     │   Tauri      │     │  typescript-language │
│  (React +    │────►│  Commands    │────►│  -server             │
│   CodeMirror)│     │  (Rust)      │     │                      │
└──────────────┘     └──────────────┘     └──────────────────────┘
       │                    │                        │
       │ invoke             │ send_request           │
       │ lsp_completion     │ textDocument/          │
       │                    │ completion             │
       │                    │                        │
       │                    │◄───────────────────────┤
       │                    │ workspace/             │
       │                    │ configuration          │
       │                    │                        │
       │                    │ (WE RESPOND!)          │
       │                    │───────────────────────►│
       │                    │ result: [{}]           │
       │                    │                        │
       │                    │◄───────────────────────┤
       │◄───────────────────│ completion result      │
       │ items: [...]       │                        │
       │                    │                        │
```

---

## Testing Instructions

### Autocomplete

1. Start the app: `npm run tauri dev`
2. Open a TypeScript or JavaScript project folder
3. Open a `.ts` or `.js` file
4. Type a variable name followed by `.` 
5. **Expected**: Completion dropdown appears with methods/properties

### Hover Tooltips

1. Open a TypeScript file
2. Hover over a variable, function, or type
3. **Expected**: Tooltip appears with type information

### Verify Server Request Handling

1. Watch the terminal output when opening a TypeScript file
2. **Expected**: See logs like:
   ```
   [LSP Transport] Server request: workspace/configuration (id: 1)
   [LSP Transport] Routing response for id: 2
   ```

---

## Summary of All Changes

### New Files (0)
No new files created - this was a fix/refactor session.

### Modified Files (10)
- `src-tauri/src/lsp/transport.rs` - Complete rewrite
- `src-tauri/src/lsp/manager.rs` - Refactored for new transport
- `src-tauri/src/lsp/protocol.rs` - Added path canonicalization
- `src/hooks/useLsp.ts` - Removed unused imports
- `src/components/editor/CodeEditor.tsx` - Minor fix
- `src/components/ai/AIChat.tsx` - Fixed unused variable
- `src/components/file-tree/FileTree.tsx` - Fixed unused parameter
- `src/stores/fileStore.ts` - Fixed unused variable
- `AGENTS.md` - Updated status
- `LSP.md` - Complete rewrite

### Documentation Updated (2)
- `AGENTS.md` - Added LSP Integration to completed features, updated next steps
- `LSP.md` - Complete rewrite with new architecture

### Dependencies Added
None - all required dependencies were already present.

### Key Fixes Applied
1. **Windows URI Format** - `file:///C:/path` instead of `file://C:/path`
2. **Response Routing** - Oneshot channels prevent response stealing between concurrent requests
3. **Server Request Handling** - Respond to `workspace/configuration` to unblock the server
4. **Enhanced Capabilities** - Added `workspaceFolders`, `configuration` support in initialize

### Architecture Changes
- Transport layer now uses background reader task
- Each request gets dedicated oneshot channel
- Server requests are handled in background reader
- 10-second timeout on all requests with proper cleanup
